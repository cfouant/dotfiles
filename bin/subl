#!/usr/bin/env ruby
#
# subl - a helper script to easily launch Sublime Text 2 from the command line
#
# USAGE: subl [FILE] ...
#
# subl finds the Sublime Text 2 executable on your system and then
# caches its location for quicker launching in the future. If you move
# Sublime Text 2 around on your system, subl will happily search for it again.
# subl is for linux machines using Sublime Text 2. Mac OS X can just symlink
# the command-line executable that is included with the Sublime Text 2
# installation. More info can be found in README.md

CACHE_FILE = "#{ENV['HOME']}/.subl_cache"

require 'find'
require 'yaml'
require 'shellwords'

def save_cache_file(ex)
  File.delete(CACHE_FILE) if File.exists?(CACHE_FILE)

  # write that junk to file
  File.open(CACHE_FILE, "w") do |file|
    file.write({:executable => ex}.to_yaml)
  end
  Shellwords.escape(ex)
end

def find_sublime_executable
  ex = []
  Find.find('/') do |path|
    ex << path if path =~ /sublime_text$/ && File.executable?(path)
  end

  # error out if subl finds more than one executable, or none
  raise "too many Sublime Text 2 executables found [ #{ex.join(", ")} ]" if ex.size > 1
  raise "no Sublime Text 2 executable found" if ex.empty?
  ex.first
end


subl_ex = []

if File.exists?(CACHE_FILE)
  file = YAML.load_file(CACHE_FILE)[:executable]

  if File.exists?(file)

    # Process.spawn acts differently depending on how many args you give it.
    # With a single argument, escaped spaces are needed (because it runs the
    # command in a standard shell), but spaces must not be escaped when passing
    # multple arguments because it doesn't execute the commands in a std shell.
    # Annoying and weird. I probably could do this a better way if I wasn't
    # using the splat operator, but I wanted to.
    subl_ex << ( (ARGV.empty?) ? Shellwords.escape(file) : file )
  else
    subl_ex << save_cache_file(find_sublime_executable())
  end
else
  subl_ex << save_cache_file(find_sublime_executable())
end

subl_ex += ARGV

Process.detach(Process.spawn(*subl_ex, :out => "/dev/null", :err => "/dev/null"))
